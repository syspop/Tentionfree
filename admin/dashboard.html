<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TentionFree</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/admin/style.css">
</head>

<body>
    <div class="admin-box">
        <nav id="admin-nav"></nav>

        <!-- Dashboard Content -->
        <h3>&#x1F4CA; Business Overview</h3>

        <div class="dash-grid">
            <div class="stat-card">
                <i class="fa-solid fa-bangladeshi-taka-sign stat-icon" style="color:#00b894;"></i>
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value" id="dash-revenue">&#x09F3;0</div>
                <div style="color:#00b894; font-size:12px;">Lifetime Earnings</div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-cart-shopping stat-icon" style="color:#6c5ce7;"></i>
                <div class="stat-label">Total Orders</div>
                <div class="stat-value" id="dash-orders">0</div>
                <div style="color:#6c5ce7; font-size:12px;">Successful Transactions</div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-users stat-icon" style="color:#ff7675;"></i>
                <div class="stat-label">Customers</div>
                <div class="stat-value" id="dash-users">0</div>
                <div style="color:#ff7675; font-size:12px;">Registered Users</div>
            </div>
        </div>

        <!-- Settings Section -->
        <h3 style="margin-top: 30px;">&#x2699; Quick Settings</h3>
        <div class="dash-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
            <div class="stat-card"
                style="flex-direction: row; justify-content: space-between; align-items: center; padding: 20px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div
                        style="width: 40px; height: 40px; background: rgba(37, 211, 102, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-brands fa-whatsapp" style="color:#25D366; font-size: 20px;"></i>
                    </div>
                    <div>
                        <div class="stat-label" style="text-align: left; margin-bottom: 2px;">Pay Later (WhatsApp)</div>
                        <div style="font-size: 11px; color: #888;">Enable offline orders via WhatsApp</div>
                    </div>
                </div>
                <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                    <input type="checkbox" id="payLaterToggle" onchange="togglePayLater(this)">
                    <span
                        style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"
                        class="slider round"></span>
                    <style>
                        .slider:before {
                            position: absolute;
                            content: "";
                            height: 18px;
                            width: 18px;
                            left: 3px;
                            bottom: 3px;
                            background-color: white;
                            transition: .4s;
                            border-radius: 50%;
                        }

                        input:checked+.slider {
                            background-color: #25D366;
                        }

                        input:checked+.slider:before {
                            transform: translateX(20px);
                        }
                    </style>
                </label>
            </div>

            <div class="chart-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h4 style="margin:0; color:white;">Sales Activity (Last 7 Days)</h4>
                    <select id="chart-filter" class="input-box" style="width:auto; margin:0; padding:5px 15px;"
                        onchange="updateChart()">
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                </div>
                <canvas id="salesChart" height="100"></canvas>
            </div>
        </div>

        <script src="/admin/script.js?v=7"></script>
        <script>
            // --- DASHBOARD LOGIC ---
            let salesChartInstance = null;

            document.addEventListener('DOMContentLoaded', loadDashboard);

            async function loadDashboard() {
                try {
                    // Fetch Data concurrently
                    // Note: API path adjusted to ../api/
                    const [ordersRes, usersRes] = await Promise.all([
                        fetch('../api/orders?t=' + Date.now()),
                        fetch('../api/customers')
                    ]);

                    const orders = await ordersRes.json();
                    const users = await usersRes.json();

                    // 1. Calculate Stats
                    const validOrders = Array.isArray(orders) ? orders.filter(o => o.status !== 'Cancelled' && o.status !== 'Deleted' && !o.isDeleted) : [];
                    const totalRevenue = validOrders.reduce((sum, o) => sum + (parseFloat(o.price) || 0), 0);
                    const totalOrders = validOrders.length;
                    const totalUsers = Array.isArray(users) ? users.length : 0;

                    // 2. Update Cards
                    // Animate Numbers
                    animateValue("dash-revenue", 0, totalRevenue, 1000, "৳");
                    animateValue("dash-orders", 0, totalOrders, 1000, "");
                    animateValue("dash-users", 0, totalUsers, 1000, "");

                    // 3. Render Chart
                    updateChartData(validOrders);

                } catch (e) {
                    console.error("Dashboard Load Error:", e);
                }
                fetchConfig(); // Call fetchConfig after dashboard data is loaded
            }

            async function fetchConfig() {
                try {
                    const res = await fetch('../api/config/pay-later');
                    const data = await res.json();
                    if (data.success) {
                        const toggle = document.getElementById('payLaterToggle');
                        if (toggle) toggle.checked = data.enabled;
                    }
                } catch (err) {
                    console.error("Config Load Error:", err);
                }
            }

            async function togglePayLater(input) {
                const enabled = input.checked;
                try {
                    // Optimistic UI update? No, let's wait or handle error
                    const res = await fetch('../api/admin/config/pay-later', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                        },
                        body: JSON.stringify({ enabled })
                    });
                    const data = await res.json();
                    if (data.success) {
                        showToast(`Pay Later is now ${enabled ? 'ON' : 'OFF'}`);
                    } else {
                        input.checked = !enabled; // Revert
                        showToast(data.message || "Failed to update", 'error');
                    }
                } catch (err) {
                    console.error(err);
                    input.checked = !enabled; // Revert
                    showToast("Network Error", 'error');
                }
            }

            function animateValue(id, start, end, duration, prefix) {
                const obj = document.getElementById(id);
                if (!obj) return;
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.innerHTML = prefix + Math.floor(progress * (end - start) + start).toLocaleString();
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }

            function updateChartData(orders) {
                const days = parseInt(document.getElementById('chart-filter').value) || 7;
                const labels = [];
                const data = [];

                for (let i = days - 1; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    labels.push(d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }));

                    // Sum revenue for this day
                    const dayRevenue = orders
                        .filter(o => o.date && o.date.startsWith(dateStr) && o.status !== 'Cancelled' && o.status !== 'Deleted')
                        .reduce((sum, o) => sum + (parseFloat(o.price) || 0), 0);

                    data.push(dayRevenue);
                }

                const ctx = document.getElementById('salesChart').getContext('2d');

                if (salesChartInstance) salesChartInstance.destroy();

                salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue (৳)',
                            data: data,
                            borderColor: '#6c5ce7',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#6c5ce7',
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: '#1e293b',
                                titleColor: '#fff',
                                bodyColor: '#cbd5e1',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: { color: '#94a3b8' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            }

            function updateChart() {
                loadDashboard(); // Re-fetch and re-render
            }
        </script>
</body>

</html>