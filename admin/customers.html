<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="admin-box">
        <nav id="admin-nav"></nav>

        <!-- Customers Content -->
        <div class="section active" style="display:block;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <h3>üë• Customer Database</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="cust-search" class="input-box" placeholder="Search Name, Email, ID..."
                        style="margin:0; width:200px; padding:8px;" onkeyup="renderCustomers()">
                    <button onclick="loadCustomers()"
                        style="cursor:pointer; background:none; border:none; color:var(--blue); font-weight:bold;">‚Üª
                        Refresh</button>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table id="cust-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Full Name</th>
                            <th>Contact Info</th>
                            <th>Joined Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="cust-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Customer Profile Modal -->
    <div id="customer-profile-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:600px; max-height:90vh; overflow-y:auto; padding:30px; border-radius:15px; border:1px solid var(--border); box-shadow:0 20px 50px rgba(0,0,0,0.5); animation:fadeIn 0.3s ease-out; position:relative;">

            <button onclick="closeCustomerModal()"
                style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.1); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer;">‚úï</button>

            <div style="text-align:center; margin-bottom:20px;">
                <div style="width:70px; height:70px; background:var(--blue); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:30px; font-weight:bold; color:white;"
                    id="cp-avatar">
                    U
                </div>
                <h3 style="margin:10px 0 5px; color:white;" id="cp-name">User Name</h3>
                <p style="margin:0; color:var(--gray); font-size:14px;" id="cp-email">user@example.com</p>
                <code
                    style="display:inline-block; margin-top:5px; background:#0f172a; padding:2px 8px; border-radius:4px; font-size:11px; color:#cbd5e1;"
                    id="cp-id">ID: 123</code>
            </div>

            <div class="grid-2" style="background:#0f172a; padding:15px; gap:15px; margin-bottom:20px;">
                <div>
                    <small
                        style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Phone</small>
                    <div style="font-weight:bold; color:white;" id="cp-phone">-</div>
                </div>
                <div>
                    <small
                        style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Joined</small>
                    <div style="font-weight:bold; color:white;" id="cp-joined">-</div>
                </div>
                <div>
                    <small style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Birth
                        Date</small>
                    <div style="font-weight:bold; color:white;" id="cp-dob">-</div>
                </div>
                <div>
                    <small style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Total
                        Orders</small>
                    <div style="font-weight:bold; color:var(--blue);" id="cp-total-orders">0</div>
                </div>
                <div>
                    <small style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Total
                        Spent</small>
                    <div style="font-weight:bold; color:var(--green);" id="cp-total-spent">‡ß≥0</div>
                </div>
            </div>

            <h4 style="color:white; margin-bottom:10px;">Order History</h4>
            <div id="cp-order-list" style="display:flex; flex-direction:column; gap:10px;">
                <!-- History items -->
            </div>
        </div>
    </div>

    <script src="script.js?v=3"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadCustomers);

        let allCustomersCache = [];

        async function loadCustomers() {
            const list = document.getElementById('cust-list');
            list.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Loading Customers...</td></tr>";

            try {
                const res = await fetch('../api/customers?t=' + Date.now(), {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('adminToken') }
                });
                const users = await res.json();

                if (Array.isArray(users)) {
                    allCustomersCache = users.reverse(); // Newest first
                    renderCustomers();
                } else {
                    throw new Error("Invalid response");
                }
            } catch (err) {
                console.error(err);
                list.innerHTML = "<tr><td colspan='5'><div class='empty-state' style='color:var(--red)'>‚ùå Failed to load customers.</div></td></tr>";
            }
        }

        function renderCustomers() {
            const list = document.getElementById('cust-list');
            const search = document.getElementById('cust-search').value.toLowerCase();
            list.innerHTML = "";

            const filtered = allCustomersCache.filter(u =>
                (u.name && u.name.toLowerCase().includes(search)) ||
                (u.email && u.email.toLowerCase().includes(search)) ||
                (u.id && u.id.toString().toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                list.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No customers found.</td></tr>";
                return;
            }

            filtered.forEach(u => {
                list.innerHTML += `
                    <tr>
                        <td><code style="background:#0f172a; padding:2px 4px; border-radius:4px; font-size:11px;">${u.id}</code></td>
                        <td><b>${u.name}</b></td>
                        <td>
                            <div style="font-size:12px;">${u.email}</div>
                            <div style="font-size:11px; color:var(--gray);">${u.phone || '-'}</div>
                        </td>
                        <td>${new Date(u.joined).toLocaleDateString()}</td>
                         <td>
                            <div style="display:flex; gap:5px;">
                                <button onclick="viewCustomer('${u.id}')" title="View Profile" style="background:rgba(59, 130, 246, 0.2); color:#3b82f6; border:none; width:28px; height:28px; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-eye"></i></button>
                                <button onclick="editCustomer('${u.id}')" title="Edit Customer" style="background:rgba(245, 158, 11, 0.2); color:#f59e0b; border:none; width:28px; height:28px; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteCustomer('${u.id}')" title="Delete Account" style="background:rgba(239, 68, 68, 0.2); color:#ef4444; border:none; width:28px; height:28px; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        async function viewCustomer(userId) {
            const user = allCustomersCache.find(u => u.id == userId);
            if (!user) return;

            // Populate User Info
            document.getElementById('cp-name').innerText = user.name;
            document.getElementById('cp-email').innerText = user.email;
            document.getElementById('cp-id').innerText = "ID: " + user.id;
            document.getElementById('cp-avatar').innerText = user.name.charAt(0).toUpperCase();
            document.getElementById('cp-phone').innerText = user.phone || 'N/A';
            document.getElementById('cp-dob').innerText = user.dob ? new Date(user.dob).toLocaleDateString() : 'N/A';
            document.getElementById('cp-joined').innerText = new Date(user.joined).toLocaleDateString();

            // Load User Orders
            const container = document.getElementById('cp-order-list');
            container.innerHTML = "<div style='text-align:center; color:var(--gray)'>Loading history...</div>";

            try {
                const res = await fetch('../api/orders?limit=1000&t=' + Date.now(), { // limit high to get history
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('adminToken') }
                });
                const data = await res.json();
                const allOrders = data.orders || data; // Handle { orders: [...] } or [...]

                const userOrders = Array.isArray(allOrders) ? allOrders.filter(o =>
                    (user.email && o.email === user.email) ||
                    (user.email && o.customerEmail === user.email) ||
                    (user.email && o.customer && o.customer.includes(user.email)) ||
                    (o.customer === user.name)
                ) : [];

                // Calc Stats
                const totalSpent = userOrders
                    .filter(o => o.status !== 'Cancelled' && o.status !== 'Deleted' && !o.isDeleted)
                    .reduce((sum, o) => sum + (parseFloat(o.totalAmount || o.price) || 0), 0);

                document.getElementById('cp-total-orders').innerText = userOrders.length;
                document.getElementById('cp-total-spent').innerText = '‡ß≥' + totalSpent;

                container.innerHTML = "";
                if (userOrders.length === 0) {
                    container.innerHTML = "<div style='text-align:center; padding:10px; background:rgba(255,255,255,0.02); border-radius:10px;'>No orders found.</div>";
                } else {
                    userOrders.reverse().forEach(o => {
                        let statusColor = "#64748b";
                        if (o.status === 'Completed') statusColor = "#10b981";
                        if (o.status === 'Pending') statusColor = "#f59e0b";
                        if (o.status === 'Cancelled') statusColor = "#ef4444";
                        if (o.status === 'Refunded') statusColor = "#a855f7";

                        container.innerHTML += `
                            <div style="background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div style="font-weight:bold; font-size:13px;">#${o.id}</div>
                                    <div style="font-size:11px; color:var(--gray);">${o.date}</div>
                                </div>
                                 <div style="text-align:right;">
                                    <div style="font-weight:bold; font-size:13px;">‡ß≥${o.totalAmount || o.price}</div>
                                    <span style="font-size:10px; color:${statusColor}; border:1px solid ${statusColor}; padding:1px 4px; border-radius:4px;">${o.status}</span>
                                </div>
                            </div>
                        `;
                    });
                }

            } catch (e) {
                console.error(e);
                container.innerHTML = "Failed to load history.";
            }

            document.getElementById('customer-profile-modal').style.display = 'flex';
        }

        function closeCustomerModal() {
            document.getElementById('customer-profile-modal').style.display = 'none';
        }

        // --- EDIT CUSTOMER LOGIC ---
        let editUserId = null;

        function editCustomer(id) {
            editUserId = id;
            const user = allCustomersCache.find(u => u.id === id);
            if (!user) return;

            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-phone').value = user.phone || '';
            document.getElementById('edit-dob').value = user.dob || '';
            document.getElementById('edit-password').value = user.password || ''; // Show current password as requested

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editUserId = null;
        }

        async function saveCustomer() {
            if (!editUserId) return;

            const data = {
                name: document.getElementById('edit-name').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value,
                dob: document.getElementById('edit-dob').value,
                password: document.getElementById('edit-password').value
            };

            const btn = document.getElementById('btn-save-cust');
            const original = btn.innerText;
            btn.innerText = "Saving...";
            btn.disabled = true;

            try {
                const res = await fetch('../api/customers/' + editUserId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.success) {
                    closeEditModal();
                    loadCustomers(); // Reload list
                } else {
                    showCustomAlert(result.message || "Failed to update", "error");
                }
            } catch (e) {
                console.error(e);
                showCustomAlert("Server Error", "error");
            } finally {
                btn.innerText = original;
                btn.disabled = false;
            }
        }

        // --- DELETE CUSTOMER LOGIC ---
        let deleteUserId = null;

        function deleteCustomer(id) {
            deleteUserId = id;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            deleteUserId = null;
        }

        async function confirmDelete() {
            if (!deleteUserId) return;

            const pass = document.getElementById('del-admin-pass').value;
            if (!pass) return showCustomAlert("Please enter admin password", "error");

            const btn = document.getElementById('btn-del-cust');
            btn.innerText = "Deleting...";
            btn.disabled = true;

            try {
                const res = await fetch('../api/customers/' + deleteUserId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify({ password: pass, isAdmin: true })
                });
                const result = await res.json();

                if (result.success) {
                    closeDeleteModal();
                    loadCustomers();
                    openSuccessModal("Account Deleted Successfully");
                } else {
                    showCustomAlert(result.message || "Failed to delete", "error");
                }
            } catch (e) {
                console.error(e);
                showCustomAlert("Server Error", "error");
            } finally {
                btn.innerText = "Delete";
                btn.disabled = false;
            }
        }


        function openSuccessModal(msg) {
            document.getElementById('success-msg').innerText = msg;
            document.getElementById('success-modal').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').style.display = 'none';
        }

        // --- Custom Alert Logic ---
        function showCustomAlert(msg, type = 'error') {
            const modal = document.getElementById('custom-alert-modal');
            const icon = document.getElementById('alert-icon');
            const iconContainer = document.getElementById('alert-icon-container');
            const title = document.getElementById('alert-title');
            const message = document.getElementById('alert-message');

            message.innerText = msg;
            modal.style.display = 'flex';

            if (type === 'error') {
                title.innerText = "Error";
                icon.className = "fa-solid fa-triangle-exclamation";
                icon.style.color = "#ef4444";
                iconContainer.style.background = "rgba(239, 68, 68, 0.15)";
            } else if (type === 'success') {
                title.innerText = "Success";
                icon.className = "fa-solid fa-check";
                icon.style.color = "#10b981";
                iconContainer.style.background = "rgba(16, 185, 129, 0.15)";
            } else {
                title.innerText = "Alert";
                icon.className = "fa-solid fa-circle-info";
                icon.style.color = "#3b82f6";
                iconContainer.style.background = "rgba(59, 130, 246, 0.15)";
            }
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').style.display = 'none';
        }

    </script>

    <!-- Edit Modal -->
    <div id="edit-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:400px; padding:30px; border-radius:15px; border:1px solid var(--border); animation:fadeIn 0.3s ease-out;">
            <h3 style="color:var(--blue); margin-top:0; margin-bottom:20px;">Edit Customer</h3>

            <div style="margin-bottom:15px;">
                <label style="color:var(--gray); font-size:12px; display:block; margin-bottom:5px;">Full Name</label>
                <input type="text" id="edit-name" class="input-box">
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:var(--gray); font-size:12px; display:block; margin-bottom:5px;">Email</label>
                <input type="email" id="edit-email" class="input-box">
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:var(--gray); font-size:12px; display:block; margin-bottom:5px;">Phone</label>
                <input type="text" id="edit-phone" class="input-box">
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:var(--gray); font-size:12px; display:block; margin-bottom:5px;">Date of
                    Birth</label>
                <input type="date" id="edit-dob" class="input-box" style="color-scheme: dark;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="color:var(--gray); font-size:12px; display:block; margin-bottom:5px;">Password</label>
                <input type="text" id="edit-password" class="input-box">
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeEditModal()" class="tab-btn"
                    style="background:var(--bg-input); border:1px solid var(--border);">Cancel</button>
                <button onclick="saveCustomer()" id="btn-save-cust" class="action-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Modal (Secure) -->
    <div id="delete-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:350px; padding:30px; border-radius:15px; border:1px solid var(--border); text-align:center; animation:fadeIn 0.3s ease-out;">
            <div
                style="margin:0 auto 20px auto; width:60px; height:60px; background:rgba(239,68,68,0.15); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i class="fa-solid fa-triangle-exclamation" style="color:#ef4444; font-size:24px;"></i>
            </div>
            <h3 style="color:white; margin-top:0;">Delete Account?</h3>
            <p style="color:var(--gray); font-size:14px; margin-bottom:15px;">This action cannot be undone.</p>

            <div style="margin-bottom:20px; text-align:left;">
                <label style="color:var(--gray); font-size:12px; display:block; margin-bottom:5px;">Enter Admin
                    Password</label>
                <input type="password" id="del-admin-pass" class="input-box" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="closeDeleteModal()" class="tab-btn"
                    style="background:var(--bg-input); border:1px solid var(--border);">Cancel</button>
                <button onclick="confirmDelete()" id="btn-del-cust" class="action-btn"
                    style="background:var(--red);">Delete</button>
            </div>
        </div>
    </div>
    <!-- Success Modal -->
    <div id="success-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2200; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:350px; padding:30px; border-radius:15px; border:1px solid var(--border); text-align:center; animation:fadeIn 0.3s ease-out; position:relative;">
            <div
                style="margin:0 auto 20px auto; width:60px; height:60px; background:rgba(16, 185, 129, 0.15); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i class="fa-solid fa-check" style="color:#10b981; font-size:24px;"></i>
            </div>
            <h3 style="color:white; margin-top:0;">Success!</h3>
            <p style="color:var(--gray); font-size:14px; margin-bottom:25px;" id="success-msg">Action completed
                successfully.</p>
            <button onclick="closeSuccessModal()" class="action-btn" style="width:100%;">Okay, Got it</button>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:350px; padding:30px; border-radius:15px; border:1px solid var(--border); text-align:center; animation:fadeIn 0.3s ease-out; position:relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <!-- Icon -->
            <div id="alert-icon-container"
                style="margin:0 auto 20px auto; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i id="alert-icon" class="fa-solid fa-triangle-exclamation" style="font-size:24px;"></i>
            </div>
            <!-- Title & Message -->
            <h3 id="alert-title" style="color:white; margin-top:0;">Alert</h3>
            <p id="alert-message" style="color:var(--gray); font-size:14px; margin-bottom:25px;">Message...</p>
            <!-- Button -->
            <button onclick="closeCustomAlert()" class="tab-btn"
                style="width:100%; background:var(--bg-input); border:1px solid var(--border); color:white; justify-content:center;">Okay</button>
        </div>
    </div>
</body>

</html>