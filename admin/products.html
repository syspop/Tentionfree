<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="admin-box">
        <nav id="admin-nav"></nav>

        <!-- Manage Products Content -->
        <div class="section active" style="display:block;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ðŸ“‹ Product List</h3>
                <div>
                    <button id="btn-reorder" onclick="toggleReorder()" class="action-btn"
                        style="background:#e67e22; margin-right:5px;">Enable Reorder</button>
                    <button id="btn-save-order" onclick="saveNewOrder()" class="success-btn" style="display:none;">Save
                        Order</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="50" class="drag-col" style="display:none;">Sort</th>
                        <th>Img</th>
                        <th>Name</th>
                        <th>Stock</th>
                        <th>Category</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="p-list"></tbody>
            </table>
        </div>
    </div>

    <!-- Product Delete Confirmation Modal -->
    <!-- Product Delete Modal Removed (Using Global Modal) -->

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadProducts);

        // --- LOAD PRODUCTS LIST (Node API) ---
        async function loadProducts() {
            const list = document.getElementById('p-list');
            list.innerHTML = "<tr><td colspan='6' style='text-align:center'>Loading...</td></tr>";

            try {
                const res = await fetch('/api/products?t=' + Date.now());
                let products = await res.json();
                if (!Array.isArray(products)) products = [];

                list.innerHTML = "";

                if (products.length === 0) {
                    list.innerHTML = "<tr><td colspan='6' style='text-align:center'>No products found. Add one!</td></tr>";
                    return;
                }

                products.forEach((p) => {
                    // Fix Image Path: prepend ../ if it's a relative local path
                    let displayImg = p.image;
                    if (displayImg && !displayImg.startsWith('http') && !displayImg.startsWith('../') && !displayImg.startsWith('data:')) {
                        displayImg = '../' + displayImg;
                    }

                    // Stock Logic (Default true if undefined)
                    const isInStock = p.inStock !== false;
                    const stockBadge = isInStock
                        ? `<button onclick="toggleStock(${p.id}, false)" class="badge" style="background:var(--green); border:none; cursor:pointer;">In Stock</button>`
                        : `<button onclick="toggleStock(${p.id}, true)" class="badge" style="background:var(--red); border:none; cursor:pointer;">Out of Stock</button>`;

                    list.innerHTML += `
                <tr data-id="${p.id}">
                    <td class="drag-col" style="display:none; cursor:grab; font-size:18px; color:var(--gray); text-align:center;">â˜°</td>
                    <td><img src="${displayImg}" width="40" style="border-radius:5px" onerror="this.src='https://placehold.co/40'"></td>
                    <td>
                        <b>${p.name}</b><br>
                        <small style="color:var(--gray)">${p.variants?.length || 0} variants</small>
                    </td>
                    <td>${stockBadge}</td>
                    <td><span class="badge" style="background:var(--blue)">${p.category}</span></td>
                    <td>
                        <button class="success-btn" onclick="editProduct(${p.id})" style="margin-right:5px; background:var(--blue)">Edit</button>
                        <button class="action-btn" onclick="deleteProduct(${p.id})">Delete</button>
                    </td>
                </tr>
            `;
                });

                // Re-apply reorder state if active
                if (document.getElementById('btn-save-order').style.display !== 'none') {
                    document.querySelectorAll('.drag-col').forEach(col => col.style.display = 'table-cell');
                }

            } catch (err) {
                console.error(err);
                list.innerHTML = "<tr><td colspan='5' style='text-align:center; color:red;'>Error loading products.</td></tr>";
            }
        }

        function editProduct(id) {
            window.location.href = `add-product?edit=${id}`;
        }

        // --- REORDER LOGIC ---
        let sortableInstance = null;

        function toggleReorder() {
            const isReordering = document.getElementById('btn-save-order').style.display !== 'none';
            const dragCols = document.querySelectorAll('.drag-col');
            const btnReorder = document.getElementById('btn-reorder');
            const list = document.getElementById('p-list');

            if (!isReordering) {
                // Enable Reordering
                btnReorder.innerText = "Cancel";
                btnReorder.style.background = "var(--gray)";
                document.getElementById('btn-save-order').style.display = 'inline-block';
                dragCols.forEach(col => col.style.display = 'table-cell');

                // Init Sortable
                sortableInstance = new Sortable(list, {
                    animation: 150,
                    handle: '.drag-col',
                    ghostClass: 'sortable-ghost'
                });
            } else {
                // Cancel Reordering
                if (sortableInstance) sortableInstance.destroy();
                btnReorder.innerText = "Enable Reorder";
                btnReorder.style.background = "#e67e22";
                document.getElementById('btn-save-order').style.display = 'none';
                dragCols.forEach(col => col.style.display = 'none');

                loadProducts(); // Reload to reset position if cancelled
            }
        }

        async function saveNewOrder() {
            const rows = document.querySelectorAll('#p-list tr');
            const newOrderIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));

            try {
                const res = await fetch('/api/products?t=' + Date.now());
                const currentProducts = await res.json();
                const productMap = new Map(currentProducts.map(p => [p.id, p]));
                const sortedProducts = newOrderIds.map(id => productMap.get(id)).filter(p => p);

                await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify(sortedProducts)
                });

                showAlert("Success", "Order Saved!");
                toggleReorder(); // Exit reorder mode
            } catch (e) {
                console.error(e);
                showAlert("Error", "Failed to save order.", "error");
            }
        }

        function deleteProduct(id) {
            showConfirm("Delete Product?", "Are you sure you want to permanently delete this product? This action cannot be undone.", () => {
                confirmProductDelete(id);
            });
        }

        async function confirmProductDelete(id) {
            try {
                await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    }
                });

                loadProducts();
            } catch (e) { showAlert("Error", "Delete failed", "error"); }
        }
        async function toggleStock(id, status) {
            try {
                // Update Single Product Stock
                await fetch(`/api/products/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify({ inStock: status })
                });

                loadProducts(); // Reload to show update
                showAlert("Success", status ? "Product Marked In Stock" : "Product Marked Out of Stock");
            } catch (e) {
                console.error(e);
                showAlert("Error", "Failed to update stock status", "error");
            }
        }
    </script>
</body>

</html>