<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="admin-box">
        <nav id="admin-nav"></nav>

        <!-- Manage Products Content -->
        <div class="section active" style="display:block;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ðŸ“‹ Product List</h3>
                <div>
                    <button id="btn-reorder" onclick="toggleReorder()" class="action-btn"
                        style="background:#e67e22; margin-right:5px;">Enable Reorder</button>
                    <button id="btn-save-order" onclick="saveNewOrder()" class="success-btn" style="display:none;">Save
                        Order</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="50" class="drag-col" style="display:none;">Sort</th>
                        <th>Img</th>
                        <th>Name</th>
                        <th>Stock</th>
                        <th>Add to Home</th>
                        <th>Category</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="p-list"></tbody>
            </table>
        </div>
    </div>

    <!-- Product Delete Confirmation Modal -->
    <!-- Product Delete Modal Removed (Using Global Modal) -->

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadProducts);

        // --- LOAD PRODUCTS LIST (Node API) ---
        async function loadProducts() {
            const list = document.getElementById('p-list');
            list.innerHTML = "<tr><td colspan='6' style='text-align:center'>Loading...</td></tr>";

            try {
                const res = await fetch('/api/products?t=' + Date.now());
                let products = await res.json();
                if (!Array.isArray(products)) products = [];

                list.innerHTML = "";

                if (products.length === 0) {
                    list.innerHTML = "<tr><td colspan='6' style='text-align:center'>No products found. Add one!</td></tr>";
                    return;
                }

                products.forEach((p) => {
                    // Fix Image Path: prepend ../ if it's a relative local path
                    let displayImg = p.image;
                    if (displayImg && !displayImg.startsWith('http') && !displayImg.startsWith('../') && !displayImg.startsWith('data:')) {
                        displayImg = '../' + displayImg;
                    }

                    // Stock Logic (Default true if undefined)
                    const isInStock = p.inStock !== false;
                    const stockBadge = isInStock
                        ? `<button onclick="toggleStock(${p.id}, false)" class="badge" style="background:var(--green); border:none; cursor:pointer;">In Stock</button>`
                        : `<button onclick="toggleStock(${p.id}, true)" class="badge" style="background:var(--red); border:none; cursor:pointer;">Out of Stock</button>`;

                    // View in Index Logic
                    const isOnHome = p.viewInIndex === true || p.viewInIndex === "true";
                    const homeBtns = `
                        <div style="display:flex; gap:5px;">
                            <button onclick="toggleHomeStatus(${p.id}, true)" 
                                style="font-size:10px; padding:4px 8px; border-radius:4px; border:none; cursor:pointer; background:${isOnHome ? 'var(--green)' : '#334155'}; color:white; font-weight:${isOnHome ? 'bold' : 'normal'}">
                                ON
                            </button>
                            <button onclick="toggleHomeStatus(${p.id}, false)" 
                                style="font-size:10px; padding:4px 8px; border-radius:4px; border:none; cursor:pointer; background:${!isOnHome ? 'var(--red)' : '#334155'}; color:white; font-weight:${!isOnHome ? 'bold' : 'normal'}">
                                OFF
                            </button>
                        </div>
                    `;

                    list.innerHTML += `
                <tr data-id="${p.id}">
                    <td class="drag-col" style="display:none; cursor:grab; font-size:18px; color:var(--gray); text-align:center;">â˜°</td>
                    <td><img src="${displayImg}" width="40" style="border-radius:5px" onerror="this.src='https://placehold.co/40'"></td>
                    <td>
                        <strong>${p.name}</strong><br>
                        <small style="color:var(--gray)">${p.variants?.length || 0} variants</small>
                    </td>
                    <td>${stockBadge}</td>
                    <td>
                         ${homeBtns}
                    </td>
                    <td><span class="badge" style="background:var(--blue)">${p.category}</span></td>
                    <td>
                        <button onclick="editProduct(${p.id})" class="action-btn edit-btn"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteProduct(${p.id})" class="action-btn delete-btn"><i class="fa-solid fa-trash"></i></button>
                        <button onclick="copyProductLink(${p.id}, '${p.name.replace(/'/g, "\\'")}')" class="action-btn" style="background:#0ea5e9; margin-left:5px;" title="Copy Product Link">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                        <button onclick="window.open('stock-manage.html?id=${p.id}', '_blank')" class="action-btn" style="background:var(--blue); margin-left:5px;" title="Manage Stock">
                            <i class="fa-solid fa-boxes-stacked"></i>
                        </button>
                    </td>
                </tr>
            `;
                });

                // Re-apply reorder state if active
                if (document.getElementById('btn-save-order').style.display !== 'none') {
                    document.querySelectorAll('.drag-col').forEach(col => col.style.display = 'table-cell');
                }

            } catch (err) {
                console.error(err);
                list.innerHTML = "<tr><td colspan='7' style='text-align:center; color:red;'>Error loading products.</td></tr>";
            }
        }

        // --- COPY LINK FUNCTION ---
        function copyProductLink(id, name) {
            // Direct ID Link (Corrected Format)
            const url = `${window.location.origin}/product-details.html?id=${id}`;

            // Robust Copy Logic
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast("Link Copied! ðŸ“‹");
                }).catch(err => copyFallback(url));
            } else {
                copyFallback(url);
            }
        }

        function copyFallback(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";  // Avoid scrolling to bottom
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("Link Copied! ðŸ“‹");
            } catch (err) {
                console.error('Failed to copy: ', err);
                showToast("Failed to copy link âŒ");
            }
            document.body.removeChild(textArea);
        }

        function showToast(msg) {
            // Check if toast container exists, else create it
            let toast = document.getElementById('toast-notification');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-notification';
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: var(--brand);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    z-index: 3000;
                    font-family: 'Poppins', sans-serif;
                    font-size: 14px;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(toast);
            }

            toast.innerText = msg;
            toast.style.opacity = '1';

            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        function editProduct(id) {
            window.location.href = `add-product.html?edit=${id}`;
        }

        // --- REORDER LOGIC ---
        let sortableInstance = null;

        function toggleReorder() {
            const isReordering = document.getElementById('btn-save-order').style.display !== 'none';
            const dragCols = document.querySelectorAll('.drag-col');
            const btnReorder = document.getElementById('btn-reorder');
            const list = document.getElementById('p-list');

            if (!isReordering) {
                // Enable Reordering
                btnReorder.innerText = "Cancel";
                btnReorder.style.background = "var(--gray)";
                document.getElementById('btn-save-order').style.display = 'inline-block';
                dragCols.forEach(col => col.style.display = 'table-cell');

                // Init Sortable
                sortableInstance = new Sortable(list, {
                    animation: 150,
                    handle: '.drag-col',
                    ghostClass: 'sortable-ghost'
                });
            } else {
                // Cancel Reordering
                if (sortableInstance) sortableInstance.destroy();
                btnReorder.innerText = "Enable Reorder";
                btnReorder.style.background = "#e67e22";
                document.getElementById('btn-save-order').style.display = 'none';
                dragCols.forEach(col => col.style.display = 'none');

                loadProducts(); // Reload to reset position if cancelled
            }
        }

        async function saveNewOrder() {
            const rows = document.querySelectorAll('#p-list tr');
            const newOrderIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));

            try {
                const res = await fetch('/api/products?t=' + Date.now());
                const currentProducts = await res.json();
                const productMap = new Map(currentProducts.map(p => [p.id, p]));
                const sortedProducts = newOrderIds.map(id => productMap.get(id)).filter(p => p);

                const saveRes = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify(sortedProducts)
                });

                if (!saveRes.ok) throw new Error("Server failed to save order");

                showAlert("Success", "Order Saved!");
                toggleReorder(); // Exit reorder mode
            } catch (e) {
                console.error(e);
                showAlert("Error", "Failed to save order.", "error");
            }
        }

        function deleteProduct(id) {
            showConfirm("Delete Product?", "Are you sure you want to permanently delete this product? This action cannot be undone.", () => {
                confirmProductDelete(id);
            });
        }

        async function confirmProductDelete(id) {
            try {
                await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    }
                });

                loadProducts();
            } catch (e) { showAlert("Error", "Delete failed", "error"); }
        }
        function toggleStock(id, status) {
            showConfirm("Update Stock?", `Mark product as ${status ? 'IN STOCK' : 'OUT STOCK'}?`, async () => {
                await performStockUpdate(id, status);
            });
        }

        async function performStockUpdate(id, status) {
            try {
                const res = await fetch(`/api/products/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify({ inStock: status })
                });
                if (res.ok) {
                    loadProducts();
                    showToast("Stock updated!", "success");
                } else {
                    showAlert("Error", "Update failed", "error");
                }
            } catch (e) {
                console.error(e);
                showAlert("Error", "Connection error", "error");
            }
        }

        async function toggleHomeStatus(id, isChecked) {
            // Optimistic UI update could be done here, but reload ensures sync
            try {
                const res = await fetch(`/api/products/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify({ viewInIndex: isChecked })
                });

                const data = await res.json();
                if (data.success) {
                    showToast("Status updated successfully");
                } else {
                    showToast("Failed to update status: " + (data.message || "Unknown error"), 'error');
                    // Revert select check
                    checkbox.checked = !isChecked;
                }
            } catch (err) {
                console.error(err);
                showToast("Network error updating status", 'error');
                checkbox.checked = !isChecked;
            }
        }
    </script>
</body>

</html>