<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="admin-box">
        <nav id="admin-nav"></nav>

        <!-- Order History Content -->
        <div class="section active" style="display:block;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <h3>üìú Order History</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="history-search" class="input-box" placeholder="Search Order ID..."
                        style="margin:0; width:200px; padding:8px;" onkeyup="filterHistory()">
                    <button onclick="loadOrders()"
                        style="cursor:pointer; background:none; border:none; color:var(--blue); font-weight:bold;">‚Üª
                        Refresh</button>
                </div>
            </div>

            <div style="overflow-x:auto;">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Order ID</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="history-order-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- View Order Modal -->
    <div id="order-view-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;"
        onclick="if(event.target === this) this.style.display='none'">
        <div
            style="background:var(--bg-card); width:500px; max-width:90%; padding:30px; border-radius:20px; border:1px solid var(--border); box-shadow:0 20px 50px rgba(0,0,0,0.5); animation:fadeIn 0.3s ease-out; position:relative;">
            <button onclick="document.getElementById('order-view-modal').style.display='none'"
                style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.1); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer;">‚úï</button>

            <h3
                style="color:var(--blue); margin-top:0; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:20px;">
                Order Details <span id="view-order-id" style="color:var(--gray); font-size:16px;"></span>
            </h3>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <div>
                    <small
                        style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Customer</small>
                    <div id="view-customer" style="font-weight:bold; color:white;"></div>
                </div>
                <div>
                    <small
                        style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Date</small>
                    <div id="view-date" style="color:#cbd5e1;"></div>
                </div>
                <div>
                    <small
                        style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Payment</small>
                    <div id="view-method" style="color:#cbd5e1;"></div>
                </div>
                <div>
                    <small
                        style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Transaction
                        ID</small>
                    <div id="view-transaction" style="color:#cbd5e1; font-family:monospace;"></div>
                </div>
                <div>
                    <small
                        style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold;">Status</small>
                    <div id="view-status"></div>
                </div>
            </div>

            <small
                style="color:var(--gray); text-transform:uppercase; font-size:10px; font-weight:bold; display:block; margin-bottom:10px;">Items</small>
            <div id="view-items"
                style="background:#0f172a; padding:15px; border-radius:10px; margin-bottom:20px; font-size:13px; color:#e2e8f0;">
            </div>

            <div id="view-delivery-container"
                style="display:none; background:rgba(16,185,129,0.1); padding:15px; border-radius:10px; border:1px solid rgba(16,185,129,0.2);">
                <small
                    style="color:#10b981; text-transform:uppercase; font-size:10px; font-weight:bold; display:block; margin-bottom:5px;">Delivery
                    Info</small>
                <div id="view-delivery" style="font-family:monospace; color:white;"></div>
            </div>
            <div id="view-cancel-container"
                style="display:none; background:rgba(239,68,68,0.1); padding:15px; border-radius:10px; border:1px solid rgba(239,68,68,0.2);">
                <small
                    style="color:#ef4444; text-transform:uppercase; font-size:10px; font-weight:bold; display:block; margin-bottom:5px;">Cancellation
                    Reason</small>
                <div id="view-cancel" style="color:#cbd5e1;"></div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadOrders);

        let allOrdersCache = [];

        async function loadOrders() {
            const list = document.getElementById('history-order-list');
            list.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Loading...</td></tr>";

            try {
                const res = await fetch('/api/orders?t=' + Date.now(), {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('adminToken') }
                });
                const orders = await res.json();

                if (!Array.isArray(orders)) throw new Error("Invalid format");
                allOrdersCache = orders.reverse(); // Newest first

                renderOrderHistory(allOrdersCache);

            } catch (err) {
                console.error(err);
                list.innerHTML = "<tr><td colspan='6'><div class='empty-state' style='color:var(--red)'>‚ùå Error loading orders.</div></td></tr>";
            }
        }

        function renderOrderHistory(orders) {
            const list = document.getElementById('history-order-list');
            list.innerHTML = "";

            const search = document.getElementById('history-search').value.toLowerCase();

            // Show all (including deleted/archived for history purposes)
            // Or maybe separate "Deleted"? The prompt logic showed everything.
            // Let's filter by search.
            const filtered = orders.filter(o => o.id.toString().includes(search));

            if (filtered.length === 0) {
                list.innerHTML = "<tr><td colspan='6'><div class='empty-state'>üìú No order history found.</div></td></tr>";
                return;
            }

            filtered.forEach(o => {
                let statusBadge = getStatusBadge(o.status);
                let rowStyle = (o.isDeleted || o.status === 'Deleted') ? 'opacity: 0.6;' : '';

                list.innerHTML += `
                    <tr style="${rowStyle}">
                        <td><small>${o.date}</small></td>
                        <td><b>${o.customer || o.customerName}</b></td>
                        <td><b>#${o.id}</b></td>
                        <td>‡ß≥${o.totalAmount || o.price}</td>
                        <td>${statusBadge}</td>
                        <td>
                             <button onclick="viewOrder(${o.id})" style="background:#0984e3; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px; margin-right:5px;">View</button>
                             <button onclick="downloadInvoice(${o.id})" style="background:#0984e3; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px;" title="Download Invoice"><i class="fa-solid fa-file-arrow-down"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function getStatusBadge(status) {
            if (status === 'Completed') return '<span class="badge bg-success">Completed</span>';
            if (status === 'Cancelled') return '<span class="badge" style="background:var(--red)">Cancelled</span>';
            if (status === 'Deleted') return '<span class="badge" style="background:var(--gray)">Deleted</span>';
            return '<span class="badge bg-pending">Pending</span>';
        }

        function filterHistory() {
            renderOrderHistory(allOrdersCache);
        }

        function viewOrder(id) {
            const order = allOrdersCache.find(o => o.id == id);
            if (!order) return;

            document.getElementById('view-order-id').innerText = '#' + order.id;
            document.getElementById('view-customer').innerText = order.customerName || order.customer || 'Unknown';
            document.getElementById('view-date').innerText = order.date;
            document.getElementById('view-method').innerText = order.paymentMethod;
            document.getElementById('view-transaction').innerText = order.trx || order.transactionId || 'N/A';
            document.getElementById('view-status').innerHTML = getStatusBadge(order.status);

            // Items
            const items = order.items || order.cart || [];
            let itemsHtml = "";
            if (Array.isArray(items)) {
                itemsHtml = items.map(i => `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; padding-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <span>${i.name} <span style="font-size:10px; color:var(--gray);">&times;${i.qty || 1}</span></span>
                        <span>‡ß≥${(i.price * (i.qty || 1))}</span>
                    </div>`).join('');
            } else {
                itemsHtml = order.product || 'Unknown Item';
            }
            // Add Total
            itemsHtml += `<div style="text-align:right; font-weight:bold; margin-top:10px; color:#10b981;">Total: ‡ß≥${order.totalAmount || order.price}</div>`;

            document.getElementById('view-items').innerHTML = itemsHtml;

            // Delivery Info
            if (order.deliveryInfo) {
                document.getElementById('view-delivery-container').style.display = 'block';
                document.getElementById('view-delivery').innerText = order.deliveryInfo;
            } else {
                document.getElementById('view-delivery-container').style.display = 'none';
            }

            // Cancel Info
            if (order.cancelReason) {
                document.getElementById('view-cancel-container').style.display = 'block';
                document.getElementById('view-cancel').innerText = order.cancelReason;
            } else {
                document.getElementById('view-cancel-container').style.display = 'none';
            }

            document.getElementById('order-view-modal').style.display = 'flex';
        }


        function downloadInvoice(orderId) {
            const order = allOrdersCache.find(o => o.id == orderId);
            if (!order) return;

            const items = order.items || order.cart || [];
            const itemsHtml = items.length > 0 ? items.map(item => `
                <tr style="border-bottom: 1px solid #e2e8f0; background-color: #ffffff !important; color: #334155 !important;">
                    <td style="padding: 12px 15px; color: #334155 !important; background-color: #ffffff !important;">
                        <div style="font-weight: 500; color: #334155 !important;">${item.name || 'Item'}</div>
                        <div style="font-size: 12px; color: #94a3b8 !important;">${item.variant || ''}</div>
                    </td>
                    <td style="text-align:right; padding: 12px 15px; color: #64748b !important; background-color: #ffffff !important;">${item.quantity || item.qty || 1}</td>
                    <td style="text-align:right; padding: 12px 15px; color: #64748b !important; background-color: #ffffff !important;">‡ß≥${item.price || 0}</td>
                    <td style="text-align:right; padding: 12px 15px; color: #334155 !important; font-weight: 600; background-color: #ffffff !important;">‡ß≥${(item.price || 0) * (item.quantity || item.qty || 1)}</td>
                </tr>
            `).join('') : '';

            // Create a VISIBLE full-screen overlay for the invoice
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100vw';
            container.style.height = '100vh';
            container.style.zIndex = '10000'; // High z-index to stay on top
            container.style.backgroundColor = '#ffffff'; // White background
            container.style.overflowY = 'auto';
            container.style.display = 'flex';
            container.style.justifyContent = 'center';
            container.style.paddingTop = '20px';

            container.innerHTML = `
                <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; width: 800px; max-width: 90%; background: #ffffff; padding: 40px; color: #333; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                    <!-- Header -->
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px;">
                         <div style="font-size: 28px; font-weight: bold; color: #2563eb; letter-spacing: -1px;">TentionFree</div>
                         <div style="text-align:right;">
                             <div style="font-size: 12px; text-transform:uppercase; color: #64748b; font-weight:bold; letter-spacing: 1px;">Invoice</div>
                             <div style="font-size: 16px; font-weight:bold; color: #1e293b;">#${order.id}</div>
                         </div>
                    </div>

                    <!-- Info Grid -->
                    <div style="display:flex; justify-content:space-between; margin-bottom: 40px;">
                        <div>
                            <div style="font-size: 11px; text-transform:uppercase; color: #94a3b8; font-weight:bold; margin-bottom:5px;">Billed To</div>
                            <div style="font-weight:bold; color: #1e293b; margin-bottom:3px; font-size:16px;">${order.customer || order.customerName || 'Guest'}</div>
                            <div style="color: #64748b; font-size: 14px;">${order.email || ''}</div>
                            <div style="color: #64748b; font-size: 14px;">${order.phone || ''}</div>
                            ${order.gameUid && order.gameUid !== 'N/A' ? `<div style="color: #64748b; font-size: 14px; margin-top: 5px;">Player/Account ID: <span style="color: #334155; font-weight:500;">${order.gameUid}</span></div>` : ''}
                        </div>
                        <div style="text-align:right;">
                             <div style="font-size: 11px; text-transform:uppercase; color: #94a3b8; font-weight:bold; margin-bottom:5px;">Details</div>
                             <div style="color: #64748b; font-size: 14px; margin-bottom: 3px;">Date: <span style="color: #1e293b; font-weight:600;">${new Date(order.date).toLocaleDateString()}</span></div>
                             <div style="color: #64748b; font-size: 14px; margin-bottom: 3px;">Method: <span style="color: #1e293b; font-weight:600;">${order.paymentMethod}</span></div>
                             <div style="color: #64748b; font-size: 14px;">Status: <span style="color:${order.status === 'Completed' ? '#10b981' : '#f59e0b'}; font-weight:600;">${order.status}</span></div>
                             ${order.trx ? `<div style="color: #64748b; font-size: 14px; margin-top: 3px;">TrxID: <span style="color: #334155; font-weight:600;">${order.trx}</span></div>` : ''}
                        </div>
                    </div>

                    <!-- Table -->
                    <table style="width:100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background-color: #eff6ff; border-bottom: 2px solid #e2e8f0;">
                                <th style="text-align:left; padding: 12px 15px; font-size: 12px; text-transform: uppercase; color: #475569; font-weight: 600;">Item</th>
                                <th style="text-align:right; padding: 12px 15px; font-size: 12px; text-transform: uppercase; color: #475569; font-weight: 600;">Qty</th>
                                <th style="text-align:right; padding: 12px 15px; font-size: 12px; text-transform: uppercase; color: #475569; font-weight: 600;">Price</th>
                                <th style="text-align:right; padding: 12px 15px; font-size: 12px; text-transform: uppercase; color: #475569; font-weight: 600;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <!-- Total -->
                    <div style="border-top: 2px solid #f1f5f9; padding-top: 20px; text-align: right;">
                        <span style="font-size: 14px; color: #64748b; margin-right: 15px;">Total Amount</span>
                        <span style="font-size: 24px; font-weight: bold; color: #2563eb;">‡ß≥${order.price || order.totalAmount || 0}</span>
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 60px; text-align: center; border-top: 1px solid #f1f5f9; padding-top: 30px;">
                        <div style="font-size: 14px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">TentionFree</div>
                        <div style="font-size: 12px; color: #94a3b8;">Digital Product Shop Bangladesh</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top:5px;">Thank you for your business!</div>
                    </div>
                </div>
            `;

            // Append to body momentarily for rendering
            document.body.appendChild(container);

            const elementToPrint = container.children[0];

            // Use html2pdf to generate and save
            const opt = {
                margin: 0,
                filename: `Invoice_${order.id}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff', scrollY: 0 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(elementToPrint).save().then(() => {
                document.body.removeChild(container);
            });
        }
    </script>
</body>

</html>