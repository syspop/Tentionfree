<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="admin-box">
        <nav id="admin-nav"></nav>

        <!-- Add Product Content -->
        <div class="section active" style="display:block;">
            <h3>üì¶ New Product Setup</h3>

            <div class="grid-2" style="grid-template-columns: 2fr 1fr;">
                <div>
                    <label>Product Name</label>
                    <input type="text" id="p-name" class="input-box" placeholder="e.g. Netflix Premium">

                    <label class="text-brand-400">Custom Badge (Optional)</label>
                    <input type="text" id="p-badge" class="input-box" placeholder="e.g. HOT, 50% OFF, BEST SELLER">

                    <label>Category</label>
                    <select id="p-category" class="input-box">
                        <option value="streaming">Streaming</option>
                        <option value="tools">Tools & VPN</option>
                        <option value="gaming">Gaming</option>
                    </select>

                    <label>Stock Status</label>
                    <select id="p-stock" class="input-box">
                        <option value="true">In Stock</option>
                        <option value="false">Out of Stock</option>
                    </select>
                </div>
                <div>
                    <label>Image URL</label>
                    <input type="text" id="p-img" class="input-box" placeholder="e.g. images/Netflix.png">
                </div>
            </div>

            <label>Short Description (Card)</label>
            <input type="text" id="p-desc" class="input-box" placeholder="e.g. 4K UHD | Private Profile">

            <label>Long Description (Modal details)</label>
            <textarea id="p-long-desc" class="input-box" rows="3" placeholder="Detailed description..."></textarea>

            <label>Features (One per line)</label>
            <textarea id="p-features" class="input-box" rows="4"
                placeholder="4K Ultra HD&#10;Private Profile&#10;..."></textarea>

            <label>Instructions (After Purchase)</label>
            <textarea id="p-instructions" class="input-box" rows="2" placeholder="Delivery instructions..."></textarea>

            <!-- Variants Section -->
            <div style="background:#020617; padding:15px; border-radius:10px; margin-bottom:20px;">
                <h4 style="margin-top:0; color:var(--blue)">üè∑Ô∏è Pricing Variants</h4>
                <div id="variants-container"></div>
                <button onclick="addVariantRow()"
                    style="background:var(--bg-card); color:white; border:1px solid var(--border); padding:8px 15px; border-radius:5px; cursor:pointer; font-size:12px;">
                    + Add Variant
                </button>
            </div>

            <button class="btn-main" onclick="saveProduct()">Save Product</button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="save-success-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:320px; padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; animation:fadeIn 0.3s ease-out; position:relative;">
            <div
                style="margin:0 auto 20px auto; width:70px; height:70px; background:rgba(16,185,129,0.15); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 20px rgba(16,185,129,0.2);">
                <i class="fa-solid fa-check" style="color:#10b981; font-size:32px;"></i>
            </div>
            <h3 style="color:white; margin-top:0; font-size:22px; margin-bottom:5px;" id="success-modal-msg">Success!
            </h3>
            <p style="color:var(--gray); font-size:14px; margin-bottom:20px;">Changes saved successfully.</p>
            <div style="width:100%; background:rgba(255,255,255,0.1); height:4px; border-radius:2px; overflow:hidden;">
                <div id="success-timer-bar"
                    style="width:100%; height:4px; background:#10b981; transition:width 3s linear;"></div>
            </div>
            <p style="color:var(--gray); font-size:12px; margin-top:10px;">Closing in <span id="success-timer-count"
                    style="font-weight:bold; color:white;">3</span>s...</p>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            addVariantRow('1 Month', '', '');

            // Check if editing (Logic for editing will be handled in products.html mainly, but if we want to share this page for edit, we need URL params. 
            // For now, let's keep it simple: this is "Add Product". "Edit" might need to redirect here with ID. 
            // Let's support URL param `?edit=ID`
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            if (editId) {
                loadProductForEdit(editId);
            }
        });

        // --- VARIANT LOGIC ---
        function addVariantRow(label = '', price = '', original = '') {
            const container = document.getElementById('variants-container');
            const div = document.createElement('div');
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '2fr 1fr 1fr 30px';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';

            div.innerHTML = `
                <input type="text" placeholder="Label (e.g. 1 Month)" class="input-box" style="margin:0" value="${label}">
                <input type="number" placeholder="Price" class="input-box" style="margin:0" value="${price}">
                <input type="number" placeholder="Org. Price" class="input-box" style="margin:0" value="${original}">
                <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold;">√ó</button>
            `;
            container.appendChild(div);
        }

        let currentEditingId = null;

        async function loadProductForEdit(id) {
            try {
                const res = await fetch('../api/products?t=' + Date.now());
                const products = await res.json();
                const p = products.find(prod => prod.id == id); // loose equality for string/num match

                if (!p) return showAlert("Error", "Product not found!", "error");

                currentEditingId = p.id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-badge').value = p.badge || '';
                document.getElementById('p-category').value = p.category;
                document.getElementById('p-stock').value = p.inStock !== false ? "true" : "false";
                document.getElementById('p-img').value = p.image;
                document.getElementById('p-desc').value = p.desc;
                document.getElementById('p-long-desc').value = p.longDesc || '';
                document.getElementById('p-features').value = p.features ? p.features.join('\n') : '';
                document.getElementById('p-instructions').value = p.instructions || '';

                const container = document.getElementById('variants-container');
                container.innerHTML = '';
                if (p.variants && p.variants.length > 0) {
                    p.variants.forEach(v => {
                        addVariantRow(v.label, v.price, v.originalPrice);
                    });
                } else {
                    addVariantRow('1 Month', '', '');
                }

                document.querySelector('.btn-main').innerText = "Update Product";
            } catch (e) { console.error(e); }
        }

        // --- SAVE PRODUCT ---
        async function saveProduct() {
            const name = document.getElementById('p-name').value;
            const badge = document.getElementById('p-badge').value;
            const category = document.getElementById('p-category').value;
            const inStock = document.getElementById('p-stock').value === "true";
            const img = document.getElementById('p-img').value;
            const desc = document.getElementById('p-desc').value;
            const longDesc = document.getElementById('p-long-desc').value;
            const features = document.getElementById('p-features').value.split('\n').filter(l => l.trim() !== '');
            const instructions = document.getElementById('p-instructions').value;

            // Variants
            const rows = document.querySelectorAll('#variants-container > div');
            const variants = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value) {
                    variants.push({
                        label: inputs[0].value,
                        price: inputs[1].value,
                        originalPrice: inputs[2].value
                    });
                }
            });

            if (!name || !img || variants.length === 0) {
                return showAlert("Missing Info", "Please fill required fields (Name, Image, at least 1 variant)", "error");
            }

            try {
                const res = await fetch('../api/products?t=' + Date.now());
                let products = await res.json();
                if (!Array.isArray(products)) products = [];

                if (currentEditingId) {
                    // Update
                    const index = products.findIndex(p => p.id == currentEditingId);
                    if (index !== -1) {
                        products[index] = {
                            ...products[index],
                            name, badge, category, inStock, image: img, desc, longDesc, features, instructions, variants
                        };
                    }
                } else {
                    // Create
                    const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                    products.push({
                        id: newId,
                        name, badge, category, inStock, image: img, desc, longDesc, features, instructions, variants
                    });
                }

                await fetch('../api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(products)
                });

                showSaveSuccessModal(currentEditingId ? "Product Updated!" : "Product Added!");

                if (!currentEditingId) {
                    resetForm();
                } else {
                    // Redirect back to products list after update?
                    setTimeout(() => window.location.href = 'products.html', 1500);
                }

            } catch (err) {
                console.error(err);
                showAlert("Error", "Error saving to server.", "error");
            }
        }

        function resetForm() {
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('variants-container').innerHTML = '';
            addVariantRow('1 Month', '', '');
            currentEditingId = null;
            document.querySelector('.btn-main').innerText = "Save Product";
        }

        function showSaveSuccessModal(msg) {
            const modal = document.getElementById('save-success-modal');
            const bar = document.getElementById('success-timer-bar');
            const countSpan = document.getElementById('success-timer-count');

            document.getElementById('success-modal-msg').innerText = msg;
            modal.style.display = 'flex';
            bar.style.transition = 'none';
            bar.style.width = '100%';

            let timeLeft = 3;
            if (countSpan) countSpan.innerText = timeLeft;

            setTimeout(() => {
                bar.style.transition = 'width 3s linear';
                bar.style.width = '0%';
            }, 10);

            const interval = setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0 && countSpan) countSpan.innerText = timeLeft;
            }, 1000);

            setTimeout(() => {
                modal.style.display = 'none';
                clearInterval(interval);
            }, 3000);
        }
    </script>
</body>

</html>