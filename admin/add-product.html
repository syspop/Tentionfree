<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="admin-box">
        <nav id="admin-nav"></nav>

        <!-- Add Product Content -->
        <div class="section active" style="display:block;">
            <h3>üì¶ New Product Setup</h3>

            <div class="grid-2" style="grid-template-columns: 2fr 1fr;">
                <div>
                    <label>Product Name</label>
                    <input type="text" id="p-name" class="input-box" placeholder="e.g. Netflix Premium">

                    <label class="text-brand-400">Custom Badge (Optional)</label>
                    <input type="text" id="p-badge" class="input-box" placeholder="e.g. HOT, 50% OFF, BEST SELLER">

                    <label>Category</label>
                    <select id="p-category" class="input-box">
                        <option value="streaming">Streaming</option>
                        <option value="tools">Tools & VPN</option>
                        <option value="gaming">Gaming</option>
                    </select>

                    <div style="margin-top:10px; margin-bottom:10px;"></div>

                    <label>Stock Status</label>
                    <select id="p-stock" class="input-box">
                        <option value="true">In Stock</option>
                        <option value="false">Out of Stock</option>
                    </select>
                </div>
                <div>
                    <label>Image (Upload or URL)</label>
                    <div style="border:2px dashed var(--border); border-radius:10px; padding:20px; text-align:center; position:relative;"
                        id="upload-area">
                        <div id="upload-placeholder">
                            <i class="fa-solid fa-cloud-arrow-up"
                                style="font-size:30px; color:var(--gray); margin-bottom:10px;"></i>
                            <p style="font-size:12px; color:var(--gray); margin:0;">Click or Drag Image Here</p>
                        </div>
                        <img id="preview-img"
                            style="max-width:100%; max-height:200px; border-radius:10px; display:none; margin:0 auto;">
                        <input type="file" id="p-image-file" accept="image/*, .svg"
                            style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;"
                            onchange="handleFileSelect(this)">
                    </div>
                    <input type="text" id="p-img" class="input-box" placeholder="OR paste Image URL..."
                        onchange="handleUrlInput()">
                    <div id="img-preview-container"
                        style="width:100%; height:150px; background:var(--bg-main); border-radius:10px; border:1px dashed var(--border); display:flex; align-items:center; justify-content:center; overflow:hidden; margin-top:5px;">
                        <span style="color:var(--gray); font-size:12px;">No Image Selected</span>
                    </div>
                </div>
            </div>

            <label>Short Description (Card)</label>
            <input type="text" id="p-desc" class="input-box" placeholder="e.g. 4K UHD | Private Profile">

            <label>Long Description (Modal details)</label>
            <textarea id="p-long-desc" class="input-box" rows="3" placeholder="Detailed description..."></textarea>

            <label>Features (One per line)</label>
            <textarea id="p-features" class="input-box" rows="4"
                placeholder="4K Ultra HD&#10;Private Profile&#10;..."></textarea>

            <label>Instructions (After Purchase)</label>
            <textarea id="p-instructions" class="input-box" rows="2" placeholder="Delivery instructions..."></textarea>

            <!-- Variants Section -->
            <div style="background:#020617; padding:15px; border-radius:10px; margin-bottom:20px;">
                <h4 style="margin-top:0; color:var(--blue)">üè∑Ô∏è Pricing Variants</h4>
                <div id="variants-container"></div>
                <button onclick="addVariantRow()"
                    style="background:var(--bg-card); color:white; border:1px solid var(--border); padding:8px 15px; border-radius:5px; cursor:pointer; font-size:12px;">
                    + Add Variant
                </button>
            </div>

            <!-- Auto Delivery Settings (Hidden by default, shown if price is 0) -->
            <div id="auto-delivery-section"
                style="background:rgba(16, 185, 129, 0.05); padding:15px; border-radius:10px; margin-bottom:20px; border:1px dashed var(--green); display:none;">
                <h4 style="margin-top:0; color:var(--green)">‚ö° Auto Delivery Settings (Free Product)</h4>
                <p style="font-size:12px; color:var(--gray); margin-bottom:10px;">These details will be emailed
                    automatically when a user "purchases" this item for 0.00.</p>

                <label>Delivery Text (Credentials/Code)</label>
                <textarea id="p-auto-info" class="input-box" rows="3"
                    placeholder="e.g. Secret Code: XYZ-123"></textarea>

                <label>Delivery Image (Optional)</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="file" id="p-auto-img-file" accept="image/*" class="input-box"
                        style="padding:5px; font-size:12px; margin:0;" onchange="handleAutoImgUpload()">
                </div>
                <!-- Hidden input for base64 storage/url -->
                <input type="hidden" id="p-auto-img">
                <div id="auto-img-preview"
                    style="width:100%; height:100px; background:var(--bg-main); border-radius:8px; display:flex; align-items:center; justify-content:center; margin-top:5px; border:1px solid var(--border);">
                    <span style="font-size:10px; color:var(--gray);">No Image</span>
                </div>
            </div>

            <button class="btn-main" onclick="saveProduct()">Save Product</button>
        </div>
    </div>



    <!-- Success Modal -->
    <div id="save-success-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:320px; padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; animation:fadeIn 0.3s ease-out; position:relative;">
            <div
                style="margin:0 auto 20px auto; width:70px; height:70px; background:rgba(16,185,129,0.15); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 20px rgba(16,185,129,0.2);">
                <i class="fa-solid fa-check" style="color:#10b981; font-size:32px;"></i>
            </div>
            <h3 style="color:white; margin-top:0; font-size:22px; margin-bottom:5px;" id="success-modal-msg">Success!
            </h3>
            <p style="color:var(--gray); font-size:14px; margin-bottom:20px;">Changes saved successfully.</p>
            <div style="width:100%; background:rgba(255,255,255,0.1); height:4px; border-radius:2px; overflow:hidden;">
                <div id="success-timer-bar"
                    style="width:100%; height:4px; background:#10b981; transition:width 3s linear;"></div>
            </div>
            <p style="color:var(--gray); font-size:12px; margin-top:10px;">Closing in <span id="success-timer-count"
                    style="font-weight:bold; color:white;">3</span>s...</p>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:320px; padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; animation:fadeIn 0.3s ease-out;">
            <div id="alert-icon-container"
                style="margin:0 auto 20px auto; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i id="alert-icon" class="fa-solid" style="font-size:28px;"></i>
            </div>
            <h3 id="alert-title" style="color:white; margin-top:0; font-size:20px; margin-bottom:10px;">Alert</h3>
            <p id="alert-message" style="color:var(--gray); font-size:14px; margin-bottom:25px; line-height:1.5;">
                Message goes here</p>
            <button onclick="closeCustomAlert()" class="btn-main" style="width:100%; padding:10px;">Okay</button>
        </div>
    </div>

    <script src="script.js?v=5"></script>
    <script>
        // Custom Alert Function
        function showCustomAlert(title, message, type = 'info') {
            const modal = document.getElementById('custom-alert-modal');
            const iconContainer = document.getElementById('alert-icon-container');
            const icon = document.getElementById('alert-icon');
            const titleEl = document.getElementById('alert-title');
            const msgEl = document.getElementById('alert-message');

            titleEl.innerText = title;
            msgEl.innerText = message;
            modal.style.display = 'flex';

            if (type === 'success') {
                iconContainer.style.background = 'rgba(16,185,129,0.15)';
                icon.className = 'fa-solid fa-check';
                icon.style.color = '#10b981';
            } else if (type === 'error') {
                iconContainer.style.background = 'rgba(239,68,68,0.15)';
                icon.className = 'fa-solid fa-xmark';
                icon.style.color = '#ef4444';
            } else {
                iconContainer.style.background = 'rgba(59,130,246,0.15)';
                icon.className = 'fa-solid fa-info';
                icon.style.color = '#3b82f6';
            }
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCategories(); // New: Load dynamic categories
            addVariantRow('1 Month', '', '');

            // Check if editing
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            if (editId) {
                console.log("Edit ID found:", editId);
                document.querySelector('h3').innerText = `üì¶ Editing Product #${editId}`; // Visual Feedback
                loadProductForEdit(editId);
            }
        });

        // --- CATEGORY MANIPULATION ---
        async function loadCategories() {
            try {
                const res = await fetch('/api/categories');
                const categories = await res.json();
                const select = document.getElementById('p-category');
                select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } catch (e) {
                console.error("Failed to load categories:", e);
                // Fallback handled by static html initially or empty
            }
        }

        // --- VARIANT LOGIC ---
        function addVariantRow(label = '', price = '', original = '') {
            const container = document.getElementById('variants-container');
            const div = document.createElement('div');
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '2fr 1fr 1fr 30px';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';

            div.innerHTML = `
                <input type="text" placeholder="Label (e.g. 1 Month)" class="input-box" style="margin:0" value="${label}">
                <input type="number" placeholder="Price" class="input-box" style="margin:0" value="${price}">
                <input type="number" placeholder="Org. Price" class="input-box" style="margin:0" value="${original}">
                <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold;">√ó</button>
            `;
            container.appendChild(div);
        }

        let currentEditingId = null;

        async function loadProductForEdit(id) {
            try {
                console.log("Fetching product for edit...");
                // Use absolute path for API
                const res = await fetch('/api/products?t=' + Date.now());
                if (!res.ok) throw new Error("Failed to fetch products");

                const products = await res.json();
                console.log("Products loaded:", products.length);

                const p = products.find(prod => prod.id == id); // loose equality for string/num match

                if (!p) {
                    console.error("Product not found with ID:", id);
                    return showAlert("Error", "Product not found!", "error");
                }

                console.log("Product found:", p);
                currentEditingId = p.id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-badge').value = p.badge || '';
                document.getElementById('p-category').value = p.category;
                document.getElementById('p-stock').value = p.inStock !== false ? "true" : "false";
                document.getElementById('p-stock').value = p.inStock !== false ? "true" : "false";
                document.getElementById('p-img').value = p.image;
                updatePreview(p.image); // Show preview
                document.getElementById('p-desc').value = p.desc;
                document.getElementById('p-long-desc').value = p.longDesc || '';
                document.getElementById('p-features').value = p.features ? p.features.join('\n') : '';
                document.getElementById('p-instructions').value = p.instructions || '';

                // Populate Auto Delivery
                document.getElementById('p-auto-info').value = p.autoDeliveryInfo || '';
                document.getElementById('p-auto-img').value = p.autoDeliveryImage || '';
                if (p.autoDeliveryImage) {
                    document.getElementById('auto-img-preview').innerHTML = `<img src="${p.autoDeliveryImage}" style="height:100%; object-fit:contain;">`;
                }

                const container = document.getElementById('variants-container');
                container.innerHTML = '';
                if (p.variants && p.variants.length > 0) {
                    p.variants.forEach(v => {
                        addVariantRow(v.label, v.price, v.originalPrice);
                    });
                } else {
                    addVariantRow('1 Month', '', '');
                }

                // Trigger check after population
                setTimeout(checkPriceForAutoDelivery, 100);

                document.querySelector('.btn-main').innerText = "Update Product";
            } catch (e) {
                console.error("Error loading product for edit:", e);
                showAlert("Error", "Failed to load product data.", "error");
            }
        }

        // --- AUTO-DELIVERY LOGIC (Toggle visibility based on price) ---
        function checkPriceForAutoDelivery() {
            // Check if any variant price is 0 OR if main price implies 0 (though mainly driven by variants in this UI)
            const rows = document.querySelectorAll('#variants-container > div');
            let hasFreeVariant = false;

            rows.forEach(row => {
                const priceInput = row.querySelectorAll('input')[1]; // 2nd input is Price
                if (priceInput && parseFloat(priceInput.value) === 0) {
                    hasFreeVariant = true;
                }
            });

            const section = document.getElementById('auto-delivery-section');
            if (hasFreeVariant) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }

        // Hook into inputs
        document.getElementById('variants-container').addEventListener('input', checkPriceForAutoDelivery);
        // Also check on load/add row
        const originalAddVariantRow = addVariantRow;
        addVariantRow = function (l, p, o) {
            originalAddVariantRow(l, p, o);
            checkPriceForAutoDelivery();
        }

        // --- IMAGE LOGIC (Updated for File Upload) ---
        // We now upload immediately or on save? Let's upload immediately for preview & URL generation.

        async function uploadImageToServer(file) {
            if (!file) return null;
            const formData = new FormData();
            formData.append('image', file);

            // Show loading state if possible
            const loadingHtml = `<div style="color:var(--blue);"><i class="fa-solid fa-spinner fa-spin"></i> Uploading...</div>`;
            return fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                },
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) return data.url;
                    else throw new Error(data.message);
                });
        }

        async function handleImageUpload() {
            const fileInput = document.getElementById('p-img-file');
            if (fileInput.files && fileInput.files[0]) {
                const previewContainer = document.getElementById('img-preview-container');
                previewContainer.innerHTML = `<span style="color:var(--blue);">Uploading...</span>`;

                try {
                    const url = await uploadImageToServer(fileInput.files[0]);
                    if (url) {
                        // Fix path for frontend: prepend nothing, server serves relative to root or we handle it.
                        // Server returns 'assets/uploads/filename'.
                        document.getElementById('p-img').value = url;
                        updatePreview(url);
                    }
                } catch (e) {
                    console.error(e);
                    showCustomAlert("Upload Failed", "Could not upload image.", "error");
                    previewContainer.innerHTML = `<span style="color:red;">Upload Failed</span>`;
                }
            }
        }

        async function handleAutoImgUpload() {
            const fileInput = document.getElementById('p-auto-img-file');
            if (fileInput.files && fileInput.files[0]) {
                const previewContainer = document.getElementById('auto-img-preview');
                previewContainer.innerHTML = `<span style="color:var(--blue);">Uploading...</span>`;

                try {
                    const url = await uploadImageToServer(fileInput.files[0]);
                    if (url) {
                        document.getElementById('p-auto-img').value = url;
                        previewContainer.innerHTML = `<img src="${url}" style="height:100%; object-fit:contain;">`;
                    }
                } catch (e) {
                    console.error(e);
                    showCustomAlert("Upload Failed", "Could not upload image.", "error");
                    previewContainer.innerHTML = `<span style="color:red;">Upload Failed</span>`;
                }
            }
        }

        function handleUrlInput() {
            const url = document.getElementById('p-img').value;
            if (url) {
                document.getElementById('p-img-file').value = "";
                updatePreview(url);
            }
        }

        function updatePreview(src) {
            const container = document.getElementById('img-preview-container');
            if (src) {
                container.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:contain;">`;
            } else {
                container.innerHTML = `<span style="color:var(--gray); font-size:12px;">No Image Selected</span>`;
            }
        }

        // --- SAVE PRODUCT ---
        async function saveProduct() {
            const name = document.getElementById('p-name').value;
            const badge = document.getElementById('p-badge').value;
            const category = document.getElementById('p-category').value;
            const inStock = document.getElementById('p-stock').value === "true";
            // Image is now just the value of the text input (populated by upload or manual)
            const img = document.getElementById('p-img').value;
            const desc = document.getElementById('p-desc').value;
            const longDesc = document.getElementById('p-long-desc').value;
            const features = document.getElementById('p-features').value.split('\n').filter(l => l.trim() !== '');
            const instructions = document.getElementById('p-instructions').value;

            // Auto Delivery
            const autoInfo = document.getElementById('p-auto-info').value;
            const autoImg = document.getElementById('p-auto-img').value;


            // Variants
            const rows = document.querySelectorAll('#variants-container > div');
            const variants = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value) {
                    variants.push({
                        label: inputs[0].value,
                        price: inputs[1].value,
                        originalPrice: inputs[2].value
                    });
                }
            });

            if (!name || !img || variants.length === 0) {
                return showAlert("Missing Info", "Please fill required fields (Name, Image, at least 1 variant)", "error");
            }

            // Derive main Price and Original Price from the first variant
            const mainPrice = variants.length > 0 ? variants[0].price : 0;
            const mainOriginalPrice = variants.length > 0 ? variants[0].originalPrice : 0;

            try {
                const productData = {
                    name, badge, category, inStock, image: img, desc, longDesc, features, instructions, variants,
                    price: mainPrice,
                    originalPrice: mainOriginalPrice,
                    autoDeliveryInfo: autoInfo,
                    autoDeliveryImage: autoImg
                };

                let res;
                if (currentEditingId) {
                    // Update Single Product
                    res = await fetch(`/api/products/${currentEditingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                        },
                        body: JSON.stringify(productData)
                    });
                } else {
                    // Create New Product
                    res = await fetch('/api/products/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                        },
                        body: JSON.stringify(productData)
                    });
                }

                if (!res.ok) {
                    const errorDate = await res.json();
                    throw new Error(errorDate.message || "Server rejected request");
                }

                showSaveSuccessModal(currentEditingId ? "Product Updated!" : "Product Added!");

                if (!currentEditingId) {
                    resetForm();
                } else {
                    setTimeout(() => window.location.href = 'products.html', 1500);
                }

            } catch (err) {
                console.error(err);
                showAlert("Error", "Error saving to server.", "error");
            }
        }

        function resetForm() {
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('variants-container').innerHTML = '';
            addVariantRow('1 Month', '', '');
            currentEditingId = null;
            document.querySelector('.btn-main').innerText = "Save Product";
        }

        function showSaveSuccessModal(msg) {
            const modal = document.getElementById('save-success-modal');
            const bar = document.getElementById('success-timer-bar');
            const countSpan = document.getElementById('success-timer-count');

            document.getElementById('success-modal-msg').innerText = msg;
            modal.style.display = 'flex';
            bar.style.transition = 'none';
            bar.style.width = '100%';

            let timeLeft = 3;
            if (countSpan) countSpan.innerText = timeLeft;

            setTimeout(() => {
                bar.style.transition = 'width 3s linear';
                bar.style.width = '0%';
            }, 10);

            const interval = setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0 && countSpan) countSpan.innerText = timeLeft;
            }, 1000);

            setTimeout(() => {
                modal.style.display = 'none';
                clearInterval(interval);
            }, 3000);
        }
    </script>
</body>

</html>