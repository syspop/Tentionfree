<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Banners - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="admin-box">
        <nav id="admin-nav"></nav>

        <!-- Manage Banners Content -->
        <div class="section active" style="display:block;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h3>üñºÔ∏è Homepage Banners</h3>
                <button onclick="openModal()" class="action-btn">
                    <i class="fa-solid fa-plus"></i> Add Banner
                </button>
            </div>

            <!-- Banners Grid -->
            <div id="banner-grid"
                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px;">
                <!-- Loaded dynamically -->
                <div style="grid-column: 1/-1; text-align:center; padding:40px; color:var(--gray);">
                    <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Banner Modal -->
    <div id="banner-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div
            style="background:var(--bg-card); width:500px; max-width:90%; padding:30px; border-radius:15px; border:1px solid var(--border); animation:fadeIn 0.3s ease-out; position:relative;">

            <button onclick="closeModal()"
                style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; cursor:pointer; font-size:18px;">
                <i class="fa-solid fa-times"></i>
            </button>

            <h3 style="color:var(--blue); margin-top:0; margin-bottom:20px;">Add New Banner</h3>

            <div style="margin-bottom:15px;">
                <label style="color:var(--gray); font-size:12px; display:block; margin-bottom:5px;">Banner Image
                    (Upload)</label>

                <div style="border:2px dashed var(--border); border-radius:10px; padding:20px; text-align:center; position:relative; background:var(--bg-main);"
                    id="upload-area">
                    <div id="upload-placeholder">
                        <i class="fa-solid fa-cloud-arrow-up"
                            style="font-size:30px; color:var(--gray); margin-bottom:10px;"></i>
                        <p style="font-size:12px; color:var(--gray); margin:0;">Click or Drag Image Here</p>
                    </div>
                    <img id="preview-img"
                        style="max-width:100%; max-height:150px; border-radius:10px; display:none; margin:0 auto;">
                    <input type="file" id="banner-file" accept="image/*"
                        style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;"
                        onchange="handleFileSelect(this)">
                </div>
            </div>

            <div style="margin-bottom:25px;">
                <label style="color:var(--gray); font-size:12px; display:block; margin-bottom:5px;">Link URL
                    (Optional)</label>
                <input type="text" id="banner-link" class="input-box" placeholder="e.g. /products.html?id=123"
                    style="margin:0;">
                <p style="font-size:10px; color:var(--gray); margin-top:5px;">Where should this banner take the user?
                </p>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeModal()" class="tab-btn" style="background:var(--bg-input);">Cancel</button>
                <button onclick="saveBanner()" id="save-btn" class="action-btn">Save Banner</button>
            </div>
        </div>
    </div>

    <!-- Ensure we refer to a versioned script to avoid caching issues -->
    <script src="script.js?v=5"></script>
    <script>
        // Auth check is handled by script.js mostly, but good to ensure
        const token = localStorage.getItem('adminToken');
        if (!token) window.location.href = 'index.html'; // or login

        let uploadUrl = '';

        document.addEventListener('DOMContentLoaded', fetchBanners);

        async function fetchBanners() {
            try {
                const res = await fetch('/api/banners');
                const banners = await res.json();
                renderBanners(banners);
            } catch (err) {
                console.error("Failed to load banners", err);
                document.getElementById('banner-grid').innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--red);">Failed to load banners.</div>`;
            }
        }

        function renderBanners(banners) {
            const grid = document.getElementById('banner-grid');
            grid.innerHTML = '';

            if (!Array.isArray(banners) || banners.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align:center; padding:60px 20px; color:var(--gray); border:1px dashed var(--border); border-radius:10px;">
                        <i class="fa-regular fa-images" style="font-size:40px; opacity:0.5; margin-bottom:15px;"></i>
                        <p>No banners active. Add one to get started.</p>
                    </div>
                `;
                return;
            }

            banners.forEach(banner => {
                grid.innerHTML += `
                    <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:15px; overflow:hidden; position:relative; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:transform 0.2s;">
                        <div style="position:relative; aspect-ratio: 16/9; background:#000;">
                            <img src="${banner.image}" style="width:100%; height:100%; object-fit:cover;">
                            <div style="position:absolute; top:10px; right:10px;">
                                <button onclick="deleteBanner(${banner.id})" 
                                    style="background:rgba(239, 68, 68, 0.9); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div style="padding:15px;">
                            <div style="font-size:12px; color:var(--gray); margin-bottom:5px; display:flex; align-items:center;">
                                <i class="fa-solid fa-link" style="margin-right:5px; font-size:10px;"></i> Link
                            </div>
                            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:13px; color:white; font-family:monospace; background:var(--bg-main); padding:5px 8px; border-radius:5px;">
                                ${banner.link || '<span style="color:#64748b">No Link</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // --- MODAL LOGIC ---
        const modal = document.getElementById('banner-modal');

        function openModal() {
            resetForm();
            modal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function resetForm() {
            document.getElementById('banner-link').value = '';
            document.getElementById('banner-file').value = '';
            document.getElementById('preview-img').src = '';
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('upload-placeholder').style.display = 'block';
            uploadUrl = '';
            // Reset button state
            const btn = document.getElementById('save-btn');
            btn.innerText = 'Save Banner';
            btn.disabled = false;
        }

        // --- FILE HANDLING ---
        async function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('upload-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(file);

            // Upload immediately
            const formData = new FormData();
            formData.append('image', file);

            try {
                const btn = document.getElementById('save-btn');
                const originalText = btn.innerText;
                btn.innerText = 'Uploading...';
                btn.disabled = true;

                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    uploadUrl = data.imageUrl;
                    btn.innerText = 'Save Banner'; // Ready to save
                    btn.disabled = false;
                } else {
                    alert('Upload failed: ' + (data.message || 'Unknown error'));
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert('Upload failed due to network error.');
                document.getElementById('save-btn').disabled = false;
            }
        }

        async function saveBanner() {
            if (!uploadUrl) {
                alert('Please upload an image first.');
                return;
            }

            const link = document.getElementById('banner-link').value.trim();
            const btn = document.getElementById('save-btn');

            btn.innerText = 'Saving...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/banners', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        image: uploadUrl,
                        link: link
                    })
                });

                if (res.ok) {
                    closeModal();
                    fetchBanners();
                } else {
                    alert('Failed to save banner.');
                }
            } catch (e) {
                console.error(e);
                alert('Error saving banner.');
            } finally {
                btn.innerText = 'Save Banner';
                btn.disabled = false;
            }
        }

        async function deleteBanner(id) {
            if (!confirm('Are you sure you want to delete this banner?')) return;

            try {
                const res = await fetch(`/api/banners/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    fetchBanners();
                } else {
                    alert('Failed to delete.');
                }
            } catch (e) {
                console.error(e);
                alert('Error connecting to server.');
            }
        }
    </script>
</body>

</html>