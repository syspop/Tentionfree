<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Banners - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#6366f1',
                            600: '#4f46e5',
                        },
                        dark: {
                            bg: '#0f172a',
                            surface: '#1e293b'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-dark-bg text-gray-200 font-sans antialiased min-h-screen">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-dark-surface border-r border-gray-700 hidden md:flex flex-col">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-white flex items-center">
                    <i class="fa-solid fa-layer-group text-brand-500 mr-3"></i> Admin
                </h1>
            </div>

            <nav class="flex-1 px-4 space-y-2 overflow-y-auto">
                <a href="dashboard.html"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-chart-line w-6"></i> Dashboard
                </a>
                <a href="manage-orders.html"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-shopping-cart w-6"></i> Orders
                </a>
                <a href="products.html"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-box w-6"></i> Products
                </a>
                <a href="manage-categories.html"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-tags w-6"></i> Categories
                </a>
                <a href="customers.html"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-users w-6"></i> Customers
                </a>
                <a href="manage-banners.html"
                    class="flex items-center px-4 py-3 bg-brand-500/10 text-brand-500 rounded-xl transition font-medium">
                    <i class="fa-solid fa-images w-6"></i> Banners
                </a>
                <a href="tickets.html"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-headset w-6"></i> Support
                </a>
            </nav>

            <div class="p-4 border-t border-gray-700">
                <button onclick="logout()"
                    class="w-full flex items-center justify-center px-4 py-2 border border-gray-600 rounded-lg text-sm hover:bg-white/5 transition">
                    <i class="fa-solid fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Header -->
            <header class="bg-dark-surface border-b border-gray-700 p-4 flex justify-between items-center md:hidden">
                <h1 class="text-xl font-bold text-white">Banners</h1>
                <button
                    onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.add('absolute', 'z-50', 'h-full')"
                    class="text-gray-400">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8">

                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Homepage Banners</h2>
                        <p class="text-gray-400 text-sm mt-1">Add promotional slides to the homepage.</p>
                    </div>
                    <button onclick="openModal()"
                        class="bg-brand-500 hover:bg-brand-600 text-white px-6 py-2.5 rounded-xl font-semibold shadow-lg shadow-brand-500/20 transition flex items-center">
                        <i class="fa-solid fa-plus mr-2"></i> Add Banner
                    </button>
                </div>

                <!-- Banners Grid -->
                <div id="banner-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Loaded dynamically -->
                    <div class="col-span-full flex justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-500"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Add Banner Modal -->
    <div id="banner-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-dark-surface border border-gray-700 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-95 opacity-0"
            id="modal-content">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Add New Banner</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white transition">
                    <i class="fa-solid fa-times text-lg"></i>
                </button>
            </div>

            <div class="p-6 space-y-5">
                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Banner Image (Recommended:
                        1920x600)</label>
                    <div class="flex flex-col items-center justify-center w-full">
                        <label for="banner-file"
                            class="flex flex-col items-center justify-center w-full h-40 border-2 border-gray-600 border-dashed rounded-xl cursor-pointer bg-white/5 hover:bg-white/10 transition group">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6" id="upload-placeholder">
                                <i
                                    class="fa-solid fa-cloud-upload-alt text-3xl text-gray-500 mb-3 group-hover:text-brand-500 transition"></i>
                                <p class="text-sm text-gray-400">Click to upload image</p>
                            </div>
                            <img id="preview-img" class="hidden w-full h-full object-cover rounded-xl">
                            <input id="banner-file" type="file" class="hidden" accept="image/*"
                                onchange="handleFileSelect(this)">
                        </label>
                    </div>
                </div>

                <!-- Link Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Link URL (Optional)</label>
                    <input type="text" id="banner-link"
                        placeholder="e.g., https://youtube.com/..., /products.html?id=123"
                        class="w-full bg-black/20 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-brand-500 transition placeholder-gray-600">
                    <p class="text-xs text-gray-500 mt-1">Can be any link: product page, YouTube video, social media,
                        etc.</p>
                </div>

            </div>

            <div class="p-6 border-t border-gray-700 bg-black/20 flex gap-3">
                <button onclick="closeModal()"
                    class="flex-1 px-4 py-2.5 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition">Cancel</button>
                <button onclick="saveBanner()"
                    class="flex-1 px-4 py-2.5 bg-brand-500 hover:bg-brand-600 text-white rounded-lg font-medium transition shadow-lg shadow-brand-500/20"
                    id="save-btn">
                    Save Banner
                </button>
            </div>
        </div>
    </div>

    <script>
        // Check Auth
        const token = localStorage.getItem('adminToken');
        if (!token) window.location.href = 'login.html';

        let uploadUrl = '';

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        }

        // Fetch Banners
        async function fetchBanners() {
            try {
                const res = await fetch('/api/banners');
                const banners = await res.json();
                renderBanners(banners);
            } catch (err) {
                console.error("Failed to load banners", err);
            }
        }

        function renderBanners(banners) {
            const grid = document.getElementById('banner-grid');
            grid.innerHTML = '';

            if (banners.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-20 text-gray-500">
                        <i class="fa-regular fa-images text-4xl mb-4 opacity-50"></i>
                        <p>No banners active. Add one to get started.</p>
                    </div>
                `;
                return;
            }

            banners.forEach(banner => {
                grid.innerHTML += `
                    <div class="bg-dark-surface border border-gray-700 rounded-xl overflow-hidden group relative">
                        <div class="aspect-[3/1] bg-black/50 relative">
                            <img src="${banner.image}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-3">
                                <button onclick="deleteBanner(${banner.id})" class="bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-red-600 transition shadow-lg">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold px-2 py-0.5 rounded bg-green-500/10 text-green-500">Active</span>
                            </div>
                            <p class="text-sm text-gray-400 truncate"><i class="fa-solid fa-link mr-1"></i> ${banner.link}</p>
                        </div>
                    </div>
                `;
            });
        }

        // Modal Logic
        const modal = document.getElementById('banner-modal');
        const modalContent = document.getElementById('modal-content');

        function openModal() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            resetForm();
        }

        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function resetForm() {
            document.getElementById('banner-link').value = '';
            document.getElementById('banner-file').value = '';
            document.getElementById('preview-img').src = '';
            document.getElementById('preview-img').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            uploadUrl = '';
        }

        // File Handling
        async function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-img').classList.remove('hidden');
                document.getElementById('upload-placeholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);

            // Upload immediately
            const formData = new FormData();
            formData.append('image', file);

            try {
                const btn = document.getElementById('save-btn');
                const originalText = btn.innerText;
                btn.innerText = 'Uploading...';
                btn.disabled = true;

                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }, // In case middleware needs it
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    uploadUrl = data.imageUrl; // Use the returned URL
                } else {
                    alert('Upload failed');
                }

                btn.innerText = originalText;
                btn.disabled = false;
            } catch (e) {
                console.error(e);
                alert('Upload failed');
            }
        }

        async function saveBanner() {
            if (!uploadUrl) {
                alert('Please select and upload an image first.');
                return;
            }

            const link = document.getElementById('banner-link').value;

            const res = await fetch('/api/banners', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    image: uploadUrl,
                    link: link
                })
            });

            if (res.ok) {
                closeModal();
                fetchBanners(); // Refresh list
            } else {
                alert('Failed to save banner');
            }
        }

        async function deleteBanner(id) {
            if (!confirm('Are you sure you want to delete this banner?')) return;

            const res = await fetch(`/api/banners/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                fetchBanners();
            } else {
                alert('Failed to delete');
            }
        }

        // Init
        fetchBanners();
    </script>
</body>

</html>