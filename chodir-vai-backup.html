<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encrypted Archive Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: 'Space Mono', monospace;
        }

        .terminal {
            border: 1px solid #0f0;
            box-shadow: 0 0 10px #0f0;
            background: rgba(0, 20, 0, 0.9);
        }

        .input-term {
            background: transparent;
            border: none;
            border-bottom: 1px solid #0f0;
            color: #0f0;
            font-family: inherit;
            outline: none;
            width: 100%;
        }

        .btn-term {
            border: 1px solid #0f0;
            color: #0f0;
            background: transparent;
            transition: all 0.2s;
        }

        .btn-term:hover {
            background: #0f0;
            color: #000;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4 overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="terminal w-full max-w-lg p-8 rounded relative z-10">
        <div class="mb-6 text-center border-b border-green-900 pb-4">
            <h1 class="text-xl font-bold tracking-widest">RESTRICTED ACCESS // LEVEL 9</h1>
            <p class="text-xs text-green-700 mt-2">Identify yourself.</p>
        </div>

        <div class="space-y-6">
            <div>
                <label class="text-xs uppercase tracking-wide opacity-70 block mb-2">> Username_</label>
                <input type="text" id="user-input" class="input-term py-2" autocomplete="off" autofocus>
            </div>
            <div>
                <label class="text-xs uppercase tracking-wide opacity-70 block mb-2">> Password_</label>
                <input type="password" id="pass-input" class="input-term py-2">
            </div>
            <div id="login-error" class="text-red-500 text-xs hidden">
                > ACCESS_DENIED: Invalid Credentials.
            </div>
            <button onclick="attemptLogin()" class="btn-term w-full py-3 font-bold uppercase tracking-widest mt-4">
                Authenticate
            </button>
        </div>
    </div>

    <!-- DASHBOARD SCREEN (Hidden initially) -->
    <div id="dashboard-screen" class="terminal w-full max-w-lg p-8 rounded relative z-10 hidden">
        <div class="text-center mb-8">
            <i class="fa-solid fa-server text-4xl mb-4 animate-pulse"></i>
            <h2 class="text-lg font-bold">SYSTEM BACKUP UTILITY</h2>
            <p class="text-xs text-green-700">Connection Established.</p>
        </div>

        <div class="border border-green-900 bg-green-900/10 p-4 mb-6 rounded text-xs leading-relaxed">
            > STATUS: ONLINE<br>
            > DATABASE: CONNECTED<br>
            > HOST: LOCALHOST<br>
            > ENCRYPTION: NONE (JSON RAW)<br>
        </div>

        <button onclick="showPinModal()" class="btn-term w-full py-4 flex items-center justify-center gap-3">
            <i class="fa-solid fa-download"></i>
            INITIATE FULL DUMP
        </button>
    </div>

    <!-- PIN MODAL (Hidden) -->
    <div id="pin-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center hidden">
        <div class="terminal p-8 max-w-sm w-full mx-4 text-center">
            <i class="fa-solid fa-lock text-3xl mb-4"></i>
            <h3 class="text-sm uppercase mb-6 tracking-widest">Security Clearance Required</h3>

            <input type="password" id="pin-input" placeholder="ENTER 6-DIGIT PIN"
                class="input-term text-center text-xl tracking-[0.5em] mb-6 py-2" maxlength="6">

            <div id="pin-error" class="text-red-500 text-xs mb-4 hidden">
                > ERROR: INVALID PIN
            </div>

            <div class="flex gap-4">
                <button onclick="closePinModal()" class="btn-term flex-1 py-2 text-xs">CANCEL</button>
                <button onclick="verifyPinAndDownload()"
                    class="btn-term flex-1 py-2 text-xs font-bold bg-green-900/30">CONFIRM</button>
            </div>
        </div>
    </div>

    <script>
        // CREDENTIALS
        const VALID_USER = "emdadul014";
        const VALID_PASS = "moga-sala"; // Secure enough for this specific request context
        const VALID_PIN = "200013";

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const pinModal = document.getElementById('pin-modal');
        const loginError = document.getElementById('login-error');
        const pinError = document.getElementById('pin-error');
        const pinInput = document.getElementById('pin-input');

        function attemptLogin() {
            const u = document.getElementById('user-input').value;
            const p = document.getElementById('pass-input').value;

            if (u === VALID_USER && p === VALID_PASS) {
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
            } else {
                loginError.classList.remove('hidden');
                setTimeout(() => loginError.classList.add('hidden'), 2000);
            }
        }

        function showPinModal() {
            pinModal.classList.remove('hidden');
            pinInput.value = '';
            pinInput.focus();
            pinError.classList.add('hidden');
        }

        function closePinModal() {
            pinModal.classList.add('hidden');
        }

        async function verifyPinAndDownload() {
            const pin = pinInput.value;

            // Pre-check Client Side (Optional, but valid since we trust the backend to fail if pin is wrong too)
            if (pin !== VALID_PIN) {
                pinError.innerHTML = "> ACCESS DENIED: INCORRECT PIN";
                pinError.classList.remove('hidden');
                return;
            }

            // Real Download
            try {
                const btn = document.querySelector('#pin-modal button:last-child');
                const origText = btn.innerText;
                btn.innerText = "DOWNLOADING...";
                const apiUrl = window.location.origin + '/api/backup?t=' + Date.now();
                console.log("Fetching from:", apiUrl);

                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin: pin })
                });

                if (!res.ok) {
                    let errorMsg = "Server Rejected PIN";
                    try {
                        const errData = await res.json();
                        if (errData.error) errorMsg = errData.error;
                    } catch (e) {
                        // fallback to status text
                        errorMsg = `Server Error (${res.status}): ${res.statusText}`;
                    }
                    throw new Error(errorMsg);
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                const contentDisp = res.headers.get('Content-Disposition');
                let filename = `tentionfree_secure_backup_${Date.now()}.json`;
                if (contentDisp && contentDisp.includes('filename=')) {
                    filename = contentDisp.split('filename=')[1].replace(/"/g, '');
                }

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                closePinModal();
                alert("> DOWNLOAD COMPLETE. KEEP THIS FILE SAFE.");

                btn.innerText = origText;

            } catch (err) {
                console.error(err);
                pinError.innerHTML = "> SERVER ERROR: " + err.message;
                pinError.classList.remove('hidden');
            }
        }

        // Enter key support
        document.getElementById('pass-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });
        document.getElementById('pin-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyPinAndDownload();
        });

    </script>
</body>

</html>